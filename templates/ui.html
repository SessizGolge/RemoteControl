<!doctype html>
<html lang="tr">
<meta charset="utf-8">
<title>LAN Remote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* --- mevcut CSS aynen --- */
body{font-family:Arial,sans-serif;background:#111;color:#eee;padding:10px;margin:0;}
h2{margin-bottom:12px;}
.card{background:#1a1a1a;padding:16px;border-radius:10px;margin-bottom:12px;display:flex;flex-direction:column;gap:10px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.flex-row.full-width{display:flex;width:100%;}
.flex-row.full-width input{flex:1;padding:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee;font-size:14px;}
.timer-row{display:flex;gap:6px;width:100%;}
.timer-row input{flex:1;text-align:center;padding:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee;font-size:14px;}
#runSelectedBtn{width:100%;padding:12px;border-radius:6px;background:#333;color:#eee;border:none;font-size:16px;cursor:pointer;transition:all 0.16s;}
#runSelectedBtn:hover{background:#444;transform:scale(1.02);}
#devices{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
.device{background:#171717;padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 8px rgba(0,0,0,0.4);opacity:0;transform:translateY(-8px);transition:all 0.28s;}
.device.show{opacity:1;transform:translateY(0);}
.device .top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.device .name{font-weight:600;}
.tasks{display:flex;flex-direction:column;gap:6px;margin-top:6px;}
.task{background:#222;padding:8px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translateY(-6px);transition:all 0.28s;}
.task.show{opacity:1;transform:translateY(0);}
.task .info{font-size:13px;color:#ddd;}
.task button{background:#b22222;color:#fff;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;}
.select-all-btn{background:#444;color:#eee;padding:8px 12px;border-radius:6px;width:fit-content;cursor:pointer;margin-bottom:8px;transition:all 0.16s;}
.select-all-btn:hover{background:#555;transform:scale(1.02);}
@media(max-width:480px){.timer-row{flex-direction:row;gap:4px;}.timer-row input{flex:1; min-width:0;}.device .top{flex-direction:column;align-items:flex-start;}}
</style>

<h2>Remote Control</h2>
<div class="card">
  <div class="flex-row full-width">
    <input id="url" type="text" placeholder="For example: https://youtube.com/..."/>
  </div>
  <div class="flex-row timer-row">
    <input id="hours" type="number" min="0" max="99" placeholder="HH"/>
    <input id="minutes" type="number" min="0" max="59" placeholder="MM"/>
    <input id="seconds" type="number" min="0" max="59" placeholder="SS"/>
  </div>
  <div class="controls">
    <button id="runSelectedBtn" onclick="openSelected()">Run Selected</button>
  </div>
</div>

<div id="devices">
  <div class="select-all-btn" onclick="toggleSelectAll()">Select All</div>
</div>

<script>
let state = { devices: {}, selected: new Set() };

// --- Device listesini server’dan çek ---
async function fetchDevices(){
    try{
        const r = await fetch('/devices');
        if(!r.ok) throw new Error('devices err');
        const devs = await r.json() || [];

        const newNames = devs.map(d => d.name);

        Object.keys(state.devices).forEach(name => {
            if(!newNames.includes(name)){
                const el = document.querySelector(`.device input[data-name="${name}"]`)?.closest('.device');
                if(el) el.remove();
                delete state.devices[name];
                state.selected.delete(name);
            }
        });

        devs.forEach(d => {
            if(!state.devices[d.name]){
                renderDevice(d);
            } else {
                state.devices[d.name].tasks = d.tasks;
                updateDeviceUI(d.name, d);
            }
            state.devices[d.name] = d;
        });

    }catch(e){ console.error("fetchDevices error", e); }
}

// --- Güncelle ---
function updateDeviceUI(name, d){
    renderTasksForDevice(name, d.tasks || []);
    const checkbox = document.querySelector(`.device input[data-name="${name}"]`);
    if(checkbox) checkbox.checked = state.selected.has(name);
}

// --- Device render ---
function renderDevice(d){
    const container = document.getElementById('devices');
    const div = document.createElement('div');
    div.className = 'device';
    const checked = state.selected.has(d.name) ? 'checked' : '';
    div.innerHTML = `
      <div class="top">
        <input type="checkbox" data-name="${d.name}" ${checked}/>
        <div class="name">${escapeHtml(d.name)}</div>
      </div>
      <div class="tasks" id="tasks_${d.name}"></div>
    `;
    div.querySelector('input[type=checkbox]').addEventListener('change', e=>{
        if(e.target.checked) state.selected.add(d.name);
        else state.selected.delete(d.name);
    });
    container.appendChild(div);
    setTimeout(()=>div.classList.add('show'), 40);
    renderTasksForDevice(d.name, d.tasks || []);
}

// --- Task render ---
function renderTasksForDevice(name, tasks){
    const tcont = document.getElementById('tasks_' + name);
    if(!tcont) return;
    tcont.innerHTML = '';
    tasks.forEach((t, idx)=>{
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task';
        taskDiv.innerHTML = `
            <div class="info"><strong>${escapeHtml(t.url)}</strong>
            <div id="time_${name}_${idx}"></div></div>
            <div><button class="delete-btn">Delete</button></div>
        `;
        taskDiv.querySelector('.delete-btn').addEventListener('click', ()=> deleteTask(name, t.run_at));
        tcont.appendChild(taskDiv);
        setTimeout(()=>taskDiv.classList.add('show'),30);
        updateSingleCountdown(name, idx, t.run_at);
    });
}

// --- Countdown ---
function parseIso(s){ return new Date(s); }
function updateSingleCountdown(name, idx, run_at_iso){
    const el = document.getElementById(`time_${name}_${idx}`);
    if(!el) return;
    const runAt = parseIso(run_at_iso);
    const diff = Math.max(0, Math.floor((runAt - new Date())/1000));
    const h=Math.floor(diff/3600), m=Math.floor((diff%3600)/60), s=diff%60;
    el.innerText=`in ${h}h ${m}m ${s}s`;
}

setInterval(()=>{Object.keys(state.devices).forEach(name=>{(state.devices[name].tasks||[]).forEach((t,idx)=>updateSingleCountdown(name,idx,t.run_at))});},1000);

// --- Timer ---
function getDelaySec(){
    const h=parseInt(document.getElementById('hours').value)||0;
    const m=parseInt(document.getElementById('minutes').value)||0;
    const s=parseInt(document.getElementById('seconds').value)||0;
    return h*3600+m*60+s;
}

// --- Run Selected (server /add_task) ---
async function openSelected(){
    const url = document.getElementById('url').value.trim();
    if(!url){ alert('URL boş olamaz'); return; }

    const clients = Array.from(state.selected);
    if(clients.length===0){ alert('Seçili client yok'); return; }

    const delay = getDelaySec();
    const run_at = new Date(Date.now() + delay*1000).toISOString();

    try{
        const r = await fetch('/add_task', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                token: 'superdupersecrettoken', // gizli token
                clients: clients,
                url: url,
                run_at_iso: run_at
            })
        });
        const j = await r.json();
        if(j.ok) fetchDevices();
        else alert('Task gönderilemedi: '+(j.error||''));
    }catch(e){ console.error(e); alert('Task gönderilemedi, konsolu kontrol et.'); }
}

// --- Delete task ---
async function deleteTask(client, run_at){
    try{
        const r = await fetch('/delete_task', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                token: 'superdupersecrettoken',
                client: client,
                run_at_iso: run_at
            })
        });
        const j = await r.json();
        if(j.ok) fetchDevices();
    }catch(e){ console.error(e); }
}

// --- Select all ---
function toggleSelectAll(){
    const all=Object.keys(state.devices);
    const allSelected=all.every(name=>state.selected.has(name));
    if(allSelected) state.selected.clear();
    else all.forEach(name=>state.selected.add(name));
    fetchDevices();
}

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

fetchDevices();
setInterval(fetchDevices,3000);
</script>

